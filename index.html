<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Simple Chat example using Ionic, Nest, Socket.IO and MongoDB</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./styles/github.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Simple Chat example using Ionic, Nest, Socket.IO and MongoDB</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_nest_application">Nest Application</a>
<ul class="sectlevel2">
<li><a href="#_database_setup">Database Setup</a></li>
<li><a href="#_nestjsmongoose">Nestjs/Mongoose</a></li>
<li><a href="#_modify_gateways_and_controllers">Modify Gateways and Controllers</a></li>
</ul>
</li>
<li><a href="#_ionic_application">Ionic Application</a>
<ul class="sectlevel2">
<li><a href="#_adding_models">Adding Models</a></li>
<li><a href="#_joining_a_chatroom">Joining a Chatroom</a></li>
<li><a href="#_building_the_room_selection_functionality">Building the Room Selection Functionality</a></li>
<li><a href="#_modifying_the_chat_functionality">Modifying the Chat Functionality</a></li>
</ul>
</li>
<li><a href="#_conclusion">Conclusion</a></li>
<li><a href="#_comments">Comments</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>source code: <a href="https://github.com/nest-ionic-examples/02-chat-with-db" class="bare">https://github.com/nest-ionic-examples/02-chat-with-db</a></p>
</div>
</div>
</div>
<div class="paragraph">
<p>In <a href="https://nest-ionic-examples.github.io/01-simple-chat">previous tutorial</a> we created a simple chat application, in this tutorial we are going to add support for MongoDb database to store messages, users and rooms.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="chat-demo.gif" alt="chat demo">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nest_application">Nest Application</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_database_setup">Database Setup</h3>
<div class="paragraph">
<p>In this tutorial we are going to use MongoDb as database however you could use another database with some little tweaks. We are going to explore two ways to add MongoDb locally.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before continue with this part, in the console go to <code>chat-api</code> folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cd chat-api</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_brew_installation">Brew Installation</h4>
<div class="paragraph">
<p>The first one is by using <a href="https://brew.sh/">brew</a> or <a href="http://linuxbrew.sh/">linuxbrew</a>, so you could run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">brew install mongodb</code></pre>
</div>
</div>
<div class="paragraph">
<p>then you could just start it running</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">brew services start mongo</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then start the mongo shell pointing to the <code>chat</code> database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">mongo chat</code></pre>
</div>
</div>
<div class="paragraph">
<p>After you start the mongo-shell you need to add user <code>chat-admin</code>, set password <code>password123</code> and add the role <code>dbAdmin</code> for <code>chat</code> database. so run next commands in the console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-sh hljs" data-lang="sh">db.createUser({user: 'chat-admin', pwd: 'password123', roles: [{role: 'dbAdmin', db: 'chat'}]})</code></pre>
</div>
</div>
<div class="paragraph">
<p>then you are going to get something like next:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">Successfully added user: {
        "user" : "chat-admin",
        "roles" : [
                {
                        "role" : "dbAdmin",
                        "db" : "chat"
                }
        ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>then just press combination <code>ctrl + C</code> to stop mongo shell.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you want to start another instance of mongodb in the same port, for example with <code>docker-compose</code>, then you need to stop this one. Hence, you could run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">brew services stop mongo</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_docker_compose_setup">Docker Compose Setup</h4>
<div class="paragraph">
<p>The second way is to use <a href="https://www.docker.com/get-started">docker</a> and <a href="https://docs.docker.com/compose/gettingstarted/">docker-compose</a>. To do that, we need to create a <code>docker-compose.yaml</code> file and add next code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">version: '3.0'
services:
  mongo:
    image: mongo
    ports:
      - 27017:27017 <i class="conum" data-value="1"></i><b>(1)</b>
    volumes:
      - ./docker-compose-files:/docker-entrypoint-initdb.d <i class="conum" data-value="2"></i><b>(2)</b>
    environment:
      MONGO_INITDB_DATABASE: chat <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>whenever we run <code>docker-compose up mongo</code> the database will run and listen on port <code>27017</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We create a virtual volume from <code>docker-compose-files</code> folder created in the host machine and share it inside the container as <code>docker-entrypoint-initdb.d</code>. In this folder we will put initialization scripts to start the database with preloaded data.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We set the default database that will be used by the application</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see in the previous file <code>docker-compose</code> needs initialization files to start the database, so we will create file <code>docker-compose-files/initdbs.js</code> which will contain the initialization script. Then add next code to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">db.createUser({
  user: 'chat-admin',
  pwd: 'password123',
  roles: [{role: 'dbAdmin', db: 'chat'}]
}); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>creates a new user <code>chat-admin</code>, sets password <code>password123</code> and add the role <code>dbAdmin</code> for <code>chat</code> database.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are several advantages of using <code>docker-compose</code> over local <code>brew</code> installation:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We can create a new MongoDB database for every project without affecting others.</p>
</li>
<li>
<p>We could destroy the database data just running: <code>docker-compose down -v</code> and restart it running <code>docker-compose up mongo</code>. This is very important for integration testing.</p>
</li>
<li>
<p>We can specify NodeJs and MongoDB version we are working, so others just need to run <code>docker-compose up mongo</code> to have the same environment as us.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_nestjsmongoose">Nestjs/Mongoose</h3>
<div class="paragraph">
<p>In order to add support for mongodb database, Nest comes with the ready to use <code>@nestjs/mongoose</code> package. This is one of the most mature available so far. Since it&#8217;s written in TypeScript, it works pretty well with the Nest framework.</p>
</div>
<div class="paragraph">
<p>Firstly, we need to install all of the required dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-sh hljs" data-lang="sh">npm i -s @nestjs/mongoose mongoose</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the installation process is completed, we can import the <code>MongooseModule</code> into the root <code>ApplicationModule</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-ts hljs" data-lang="ts">import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { MessagesGateway } from './gateways/messages/messages.gateway';
import { RoomsController } from './controllers/rooms/rooms.controller';
import { MongooseModule } from "@nestjs/mongoose"; <i class="conum" data-value="1"></i><b>(1)</b>
import { Message, MessageSchema } from './models/message.model';
import { Room, RoomSchema } from './models/room.model';
import { User, UserSchema } from './models/user.model';

@Module({
  imports: [
    MongooseModule.forRoot('mongodb://chat-admin:password123@localhost/chat', {}), <i class="conum" data-value="2"></i><b>(2)</b>
    MongooseModule.forFeature([
      {name: Message.name, schema: MessageSchema},
      {name: Room.name, schema: RoomSchema},
      {name: User.name, schema: UserSchema}
    ]), <i class="conum" data-value="3"></i><b>(3)</b>
  ],
  controllers: [
    AppController,
    RoomsController,
  ],
  providers: [AppService, MessagesGateway],
})
export class AppModule {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import <code>MongooseModule</code> from <code>@nestjs/mongoose</code> package</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add <code>MongooseModule</code> configurations for mongo database connection</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add models to <code>MongooseModule</code> so they can be injected later in the application components</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we need to create three models <code>Message</code>, <code>Room</code>, and <code>User</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/models/message.model.ts</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-ts hljs" data-lang="ts">import {User} from './user.model';
import {Room} from './room.model';
import {ObjectID} from 'bson';
import {Prop, Schema, SchemaFactory} from "@nestjs/mongoose";
import {Types} from "mongoose";

@Schema()
export class Message {

  _id: ObjectID | string;

  @Prop({required: true})
  text: string;

  @Prop({required: true})
  created: Date;

  @Prop({required: true, ref: 'User', type: Types.ObjectId})
  owner: User;

  @Prop({required: true, ref: 'Room', type: Types.ObjectId})
  room: Room | string;
}

export const MessageSchema = SchemaFactory.createForClass(Message)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/models/room.model.ts</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-ts hljs" data-lang="ts">import {Message} from './message.model';
import {User} from './user.model';
import {ObjectID} from 'bson';
import {Prop, Schema, SchemaFactory} from "@nestjs/mongoose";
import {Types} from "mongoose";

@Schema()
export class Room {
  _id: ObjectID | string;

  @Prop({required: true, maxlength: 20, minlength: 5})
  name: string;

  @Prop({type: [{type: Types.ObjectId, ref: 'Message'}]})
  messages: Message[];

  @Prop({type: [{type: Types.ObjectId, ref: 'User'}]})
  connectedUsers: User[];
}

export const RoomSchema = SchemaFactory.createForClass(Room)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/models/user.model.ts</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-ts hljs" data-lang="ts">import {Message} from './message.model';
import {Room} from './room.model';
import {ObjectID} from 'bson';
import {Types} from "mongoose";
import {Prop, Schema, SchemaFactory} from "@nestjs/mongoose";

@Schema()
export class User {
  _id?: ObjectID | string;

  @Prop({required: true, maxlength: 20, minlength: 5})
  nickname: string;

  @Prop({required: true})
  clientId: string;

  @Prop({type: [{type: Types.ObjectId, ref: 'Message'}]})
  messages?: Message[];

  @Prop({type: [{type: Types.ObjectId, ref: 'Room'}]})
  joinedRooms?: Room[];
}

export const UserSchema = SchemaFactory.createForClass(User)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_modify_gateways_and_controllers">Modify Gateways and Controllers</h3>
<div class="paragraph">
<p>After that we need to modify <code>messages.gateway.ts</code>, so we inject each db model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-ts hljs" data-lang="ts">import {OnGatewayDisconnect, SubscribeMessage, WebSocketGateway, WebSocketServer} from '@nestjs/websockets';
import { Socket } from 'socket.io';
import { Message } from '../../models/message.model';
import { User } from '../../models/user.model';
import { Room } from '../../models/room.model';
import {InjectModel} from "@nestjs/mongoose";
import {Model} from "mongoose";
import {Server} from "socket.io";

@WebSocketGateway({cors: '*:*'})
export class MessagesGateway implements OnGatewayDisconnect {

  constructor(@InjectModel(Message.name) private readonly messagesModel: Model&lt;Message&gt;,
              @InjectModel(Room.name) private readonly roomsModel: Model&lt;Room&gt;,
              @InjectModel(User.name) private readonly usersModel: Model&lt;User&gt;) { <i class="conum" data-value="1"></i><b>(1)</b>
  }

  @WebSocketServer()
  server: Server;

  async handleDisconnect(client: Socket) { <i class="conum" data-value="2"></i><b>(2)</b>
    const user = await this.usersModel.findOne({clientId: client.id});
    if (user) {
      this.server.emit('users-changed', {user: user.nickname, event: 'left'});
      user.clientId = null;
      await this.usersModel.findByIdAndUpdate(user._id, user);
    }
  }

  @SubscribeMessage('enter-chat-room') <i class="conum" data-value="3"></i><b>(3)</b>
  async enterChatRoom(client: Socket, data: { nickname: string, roomId: string }) {
    let user = await this.usersModel.findOne({nickname: data.nickname});
    if (!user) {
      user = await this.usersModel.create({nickname: data.nickname, clientId: client.id});
    } else {
      user.clientId = client.id;
      user = await this.usersModel.findByIdAndUpdate(user._id, user, {new: true});
    }
    client.join(data.roomId);
    client.broadcast.to(data.roomId)
      .emit('users-changed', {user: user.nickname, event: 'joined'}); <i class="conum" data-value="3"></i><b>(3)</b>
  }

  @SubscribeMessage('leave-chat-room') <i class="conum" data-value="4"></i><b>(4)</b>
  async leaveChatRoom(client: Socket, data: { nickname: string, roomId: string }) {
    const user = await this.usersModel.findOne({nickname: data.nickname});
    client.broadcast.to(data.roomId).emit('users-changed', {user: user.nickname, event: 'left'}); <i class="conum" data-value="3"></i><b>(3)</b>
    client.leave(data.roomId);
  }

  @SubscribeMessage('add-message') <i class="conum" data-value="5"></i><b>(5)</b>
  async addMessage(client: Socket, message: Message) {
    message.owner = await this.usersModel.findOne({clientId: client.id});
    message.created = new Date();
    message = await this.messagesModel.create(message);
    this.server.in(message.room as string).emit('message', message);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inject mongoose models for: <code>Message</code>, <code>Room</code>, and <code>User</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Handles user disconnection, it sends an event that the user is disconnected.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Handles subscription to <code>enter-chat-room</code> event, which is in charge of adding user to a chat room, if the user doesn&#8217;t exist then create a new one.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Handles subscription to <code>leave-chat-room</code> event, which remove user from the chat room and emits <code>users-changed</code> event to all users of the chat-room</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Handles subscription to <code>add-message</code> event, which is in charge of adding messages coming from users in the chat room</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then we need to modify <code>rooms.controller.ts</code>, so we inject <code>Room</code> model into it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-ts hljs" data-lang="ts">import { Body, Controller, Get, Param, Post, Query } from '@nestjs/common';
import { Room } from '../../models/room.model';
import {Model} from "mongoose";
import {InjectModel} from "@nestjs/mongoose";

@Controller('api/rooms')
export class RoomsController {
  constructor(@InjectModel(Room.name) private readonly model: Model&lt;Room&gt;) {} <i class="conum" data-value="1"></i><b>(1)</b>

  @Get()
  find(@Query('q') q) { <i class="conum" data-value="2"></i><b>(2)</b>
    if (q) return this.model.find({name: {$regex: new RegExp(`.*${q}.*`)}});
    else return this.model.find();
  }

  @Get('/:id')
  findById(@Param('id') id: string) { <i class="conum" data-value="3"></i><b>(3)</b>
    return this.model.findById(id);
  }

  @Post()
  save(@Body() item: Room) { <i class="conum" data-value="4"></i><b>(4)</b>
    return item._id
      ? this.model.findByIdAndUpdate(item._id, item, {new: true})
      : this.model.create(item);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inject <code>Room</code> mongoose model</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Handles <code>GET</code> request for <code>api/rooms</code>. This request could contains a query parameter called <code>q</code>. This could contain a partial <code>room.name</code> value so users can query to the database with values that matches the partial value. If the query parameter is not present then it will return the full list of rooms.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Handles <code>GET</code> request for <code>api/rooms/:id</code>. Finds and returns the full information of the room matching that <code>id</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Handles the <code>POST</code> request for <code>api/rooms</code>. If the item contains an <code>_id</code> value, it updates any previous created room. if not, it creates a new room with the passed values. Finally, it returns the saved value to the client.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally we need to add <code>messages.controller.ts</code>. To do that you should run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">nest g co controllers/messages</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then modify <code>messages.controller.ts</code> with next code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-ts hljs" data-lang="ts">import { Controller, Get, Query } from '@nestjs/common';
import { Message } from '../../models/message.model';
import {Model} from "mongoose";
import {InjectModel} from "@nestjs/mongoose";

@Controller('api/messages')
export class MessagesController {
  constructor(@InjectModel(Message.name) private readonly model: Model&lt;Message&gt;) {} <i class="conum" data-value="1"></i><b>(1)</b>

  @Get()
  find(@Query('where') where) { <i class="conum" data-value="2"></i><b>(2)</b>
    where = JSON.parse(where || '{}');
    return this.model.find(where).populate('owner').exec();
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inject <code>Message</code> model</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Handles <code>GET</code> request for <code>api/messages</code>. This request could contains a query parameter called <code>where</code>. This could contain any query so users can query to the database with values that matches it, for example <code>{owner: {_id: '123'}}</code>. If the <code>where</code> query parameter is not present then it will return the full list of rooms.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At the moment queries of controllers does not have any validation so it&#8217;s pretty dangerous to use it like that.</p>
</div>
<div class="paragraph">
<p>Also Gateway and Controllers need an authentication and permission system so only users with needed permissions can access and modify data.</p>
</div>
<div class="paragraph">
<p>In next tutorials I will add a better handling of it.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ionic_application">Ionic Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous tutorial inside our Ionic chat app we created 2 screens: On the first screen we picked a name and <strong>join the chat</strong>, on the second screen we show the actual <strong>chatroom with messages</strong>. In this tutorial we are going to modify the first screen, so after setting the nickname we go to another page where we select the chat room from a list, and then in the last screen we will only show messages for that specified chat room.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before continue with this part, in the console go to <code>chat-client</code> folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cd chat-clent</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_adding_models">Adding Models</h3>
<div class="paragraph">
<p>Before continue it is good idea to add the models to our app, so create next files:</p>
</div>
<div class="listingblock">
<div class="title">src/app/models/message.ts</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-ts hljs" data-lang="ts">import { User } from './user';
import { Room } from './room';

export interface Message {
  _id?: string;
  text?: string;
  owner?: User | string;
  room?: Room | string;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/app/models/room.ts</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-ts hljs" data-lang="ts">import { Message } from './message';
import { User } from './user';

export interface Room {
  _id?: string;
  name?: string;
  messages?: Message[];
  connectedUsers?: User[];
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/app/models/user.ts</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-ts hljs" data-lang="ts">import { Message } from './message';
import { Room } from './room';

export interface User {
  _id?: string;
  nickname?: string;
  clientId?: string;
  messages?: Message[];
  joinedRooms?: Room[];
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see those files are only interfaces that have the same attributes as the server entities.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even though there is a way to put this models in a separate library and share this library between the server and client we are not going to do it in this tutorial.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_joining_a_chatroom">Joining a Chatroom</h3>
<div class="paragraph">
<p>So now we need to add a way to select the chat room after setting the nickname. To do that we should modify the file <code>src/app/pages/home/home.ts</code> with the next code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-ts hljs" data-lang="ts">import { Component } from '@angular/core';
import { NavController } from '@ionic/angular';

@Component({
  selector: 'app-home',
  templateUrl: 'home.page.html',
  styleUrls: ['home.page.scss'],
})
export class HomePage {
  nickname = '';

  constructor(private navController: NavController) { }

  joinChat() {
    sessionStorage.setItem('nickname', this.nickname); <i class="conum" data-value="1"></i><b>(1)</b>
    this.navController.navigateRoot(`select-room`); <i class="conum" data-value="2"></i><b>(2)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>instead setting the nickname in the url-path we save it into the local storage variable so we can use it later.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>we redirect the user to the <code>select-room</code> page</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The template file will be the same, so you can keep the next code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-html hljs" data-lang="html">&lt;ion-header&gt;
  &lt;ion-toolbar&gt;
    &lt;ion-title&gt;
      Home
    &lt;/ion-title&gt;
  &lt;/ion-toolbar&gt;
&lt;/ion-header&gt;

&lt;ion-content padding&gt;
  &lt;ion-item&gt;
    &lt;ion-label stacked&gt;Set Nickname&lt;/ion-label&gt;
    &lt;ion-input type="text" [(ngModel)]="nickname" placeholder="Nickname"&gt;&lt;/ion-input&gt;
  &lt;/ion-item&gt;
  &lt;ion-button full (click)="joinChat()" [disabled]="!nickname"&gt;Join Chat as {{ nickname }}&lt;/ion-button&gt;
&lt;/ion-content&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_the_room_selection_functionality">Building the Room Selection Functionality</h3>
<div class="paragraph">
<p>In this page the user will select the chat room he will join, so we need a selection list and a filter box. The first step will be to create the page running next command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">ionic g page pages/select-room</code></pre>
</div>
</div>
<div class="paragraph">
<p>then we modify <code>select-room.page.html</code> to contain next code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-html hljs" data-lang="html">&lt;ion-header&gt;
  &lt;ion-toolbar&gt;
    &lt;ion-back-button slot="start" defaultHref="/home"&gt;&lt;/ion-back-button&gt;
    &lt;ion-title&gt;Select Room&lt;/ion-title&gt;
  &lt;/ion-toolbar&gt;
  &lt;ion-toolbar primary&gt;
    &lt;ion-searchbar ngModel (ngModelChange)="searchRoom($event)" autocorrect="off"&gt;&lt;/ion-searchbar&gt; <i class="conum" data-value="1"></i><b>(1)</b>
  &lt;/ion-toolbar&gt;
&lt;/ion-header&gt;

&lt;ion-content padding&gt;
  &lt;ion-list&gt;
    &lt;ion-item *ngFor="let room of rooms" (click)="joinRoom(room)"&gt; <i class="conum" data-value="2"></i><b>(2)</b>
      &lt;ion-label&gt;{{room.name}}&lt;/ion-label&gt;
    &lt;/ion-item&gt;
  &lt;/ion-list&gt;
&lt;/ion-content&gt;

&lt;ion-footer&gt;
  &lt;ion-item&gt;
    &lt;ion-input type="text" placeholder="Add Room" [(ngModel)]="roomName" name="roomName"&gt;&lt;/ion-input&gt; <i class="conum" data-value="3"></i><b>(3)</b>
    &lt;ion-button (click)="addRoom()" [disabled]="!roomName" fill="clear" size="large" slot="end"&gt;
      &lt;ion-icon name="add"&gt;&lt;/ion-icon&gt;
    &lt;/ion-button&gt;
  &lt;/ion-item&gt;
&lt;/ion-footer&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In the header we show the title and a search-box which executes the method <code>searchRoom</code> whenever user types-in and the debounce time has elapsed.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The content shows the list of rooms filtered by the search box. Whenever the user clicks on any of the items of the list, it will be redirected to the <code>chat-room</code> page.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The footer contains a text-box that receive the name of a new chat-room and a plus button which executes the method <code>addRoom</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before modifying the <code>select-room.page.ts</code> file, it will be needed to add the <code>debounce-decorator-ts</code> package. To do it, run next command at the root directory of <code>chat-client</code> app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">npm i -s debounce-decorator-ts</code></pre>
</div>
</div>
<div class="paragraph">
<p>then we modify <code>select-room.page.ts</code> to contain next code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-html hljs" data-lang="html">import { Component, OnInit } from '@angular/core';
import { Room } from '../../models/room';
import { RoomsService } from '../../services/rooms.service';
import { debounceFn } from 'debounce-decorator-ts';
import { NavController } from '@ionic/angular';

@Component({
  selector: 'app-select-room',
  templateUrl: './select-room.page.html',
  styleUrls: ['./select-room.page.scss'],
})
export class SelectRoomPage implements OnInit {

  rooms: Room[];

  roomName: string;

  constructor(private roomsService: RoomsService,
              private navController: NavController) { } <i class="conum" data-value="1"></i><b>(1)</b>

  ngOnInit() {
    this.searchRoom(''); <i class="conum" data-value="2"></i><b>(2)</b>
  }

  @debounceFn(500)
  searchRoom(q: string) { <i class="conum" data-value="3"></i><b>(3)</b>
    const params: any = {};
    if (q) { params.q = q; }
    this.roomsService.find(params).subscribe(rooms =&gt; this.rooms = rooms);
  }

  joinRoom(room: Room) { <i class="conum" data-value="4"></i><b>(4)</b>
    this.navController.navigateRoot('chat-room/' + room._id);
  }

  addRoom() { <i class="conum" data-value="5"></i><b>(5)</b>
    this.roomsService.save({name: this.roomName}).subscribe(room =&gt; {
      this.roomName = '';
      this.rooms.push(room);
    });
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In the <code>constructor</code> we inject</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In the <code>ngOnInit</code> method we search for all the rooms</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>searchRoom</code> method is in charge of searching for rooms in dependence of the parameter <code>q</code>. This method calls <code>roomsService.find</code> method passing parameter <code>q</code> to it. After receiving the rooms list, it fills a local public array to be used by the html template.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>joinRoom</code> method navigates to <code>chat-room/:id</code>. That <code>id</code> parameter is later used in the <code>chat-room</code> page.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>addRoom</code> method calls <code>roomsService.save</code> method which sends the information of the new room to the server. After saving the value, it receives the new value and adds it to the <code>rooms</code> local public variable.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_modifying_the_chat_functionality">Modifying the Chat Functionality</h3>
<div class="paragraph">
<p>To receive new chat messages inside the room we have to listen for <code>message</code> socket event which receive the messages from the server.</p>
</div>
<div class="paragraph">
<p>Whenever we get such a message we simply push the new message to an array of messages. Remember, since now we have a database to save historic data, we are going to load it.</p>
</div>
<div class="paragraph">
<p>Sending a new message is almost the same as before, we simply emit our event to the server with the right type.</p>
</div>
<div class="paragraph">
<p>Finally, we also listen to the events of users joining and leaving the room and display a little toast whenever someone comes in or leaves the room. Its the same logic again, with the <code>socket.on()</code> we can listen to all the events broadcasted from our server!</p>
</div>
<div class="paragraph">
<p>Go ahead and modify <code>chat-room.ts</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-ts hljs" data-lang="ts">import { Component, OnDestroy, OnInit } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { Socket } from 'ngx-socket-io';
import { ToastController } from '@ionic/angular';
import { Subscription } from 'rxjs';
import { MessagesService } from '../../services/messages.service'; <i class="conum" data-value="1"></i><b>(1)</b>
import { RoomsService } from '../../services/rooms.service';
import { Room } from '../../models/room';
import { Message } from '../../models/message';

@Component({
  selector: 'app-chat-room',
  templateUrl: './chat-room.page.html',
  styleUrls: ['./chat-room.page.scss'],
})
export class ChatRoomPage implements OnInit, OnDestroy {
  messages: Message[] = [];
  nickname = '';
  message = '';
  room: Room = {};

  subscription: Subscription;

  constructor(private route: ActivatedRoute,
              private socket: Socket,
              private toastCtrl: ToastController,
              private messagesService: MessagesService,
              private roomsService: RoomsService) { } <i class="conum" data-value="2"></i><b>(2)</b>

  ngOnInit() {
    this.nickname = sessionStorage.getItem('nickname'); <i class="conum" data-value="3"></i><b>(3)</b>

    this.subscription = this.route.params.subscribe(params =&gt; {
      const roomId = params.roomId; <i class="conum" data-value="4"></i><b>(4)</b>
      this.socket.emit('enter-chat-room', {roomId, nickname: this.nickname}); <i class="conum" data-value="5"></i><b>(5)</b>
      this.roomsService.findById(roomId).subscribe(room =&gt; { <i class="conum" data-value="6"></i><b>(6)</b>
        this.room = room; <i class="conum" data-value="7"></i><b>(7)</b>
        this.messagesService.find({where: JSON.stringify({room: this.room._id})}).subscribe(messages =&gt; { <i class="conum" data-value="8"></i><b>(8)</b>
          this.messages = messages; <i class="conum" data-value="9"></i><b>(9)</b>
        });
      });
    });

    this.socket.on('message', message =&gt; this.messages.push(message));

    this.socket.on('users-changed', data =&gt; {
      const user = data.user;
      if (data['event'] === 'left') {
        this.showToast('User left: ' + user);
      } else {
        this.showToast('User joined: ' + user);
      }
    });

  }

  ngOnDestroy() { <i class="conum" data-value="10"></i><b>(10)</b>
    this.subscription.unsubscribe();
    this.socket.removeAllListeners('message');
    this.socket.removeAllListeners('users-changed');
    this.socket.emit('leave-chat-room', {roomId: this.room._id, nickname: this.nickname});
  }

  sendMessage() {
    this.socket.emit('add-message', {text: this.message, room: this.room._id}); <i class="conum" data-value="11"></i><b>(11)</b>
    this.message = '';
  }

  async showToast(msg) {
    const toast = await this.toastCtrl.create({
      message: msg,
      duration: 2000
    });
    toast.present();
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We import models and services</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We inject services <code>MessagesService</code> and <code>RoomsService</code> in the constructor</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Instead getting <code>nickname</code> from url, we now get it from <code>sessionStorage</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We get the roomId from the value coming from the route path param.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We emit that the user has entered to the chat-room.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Then we get the full information of the chat-room using <code>roomsService.findById</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>After receiving the full chat-room info, we set it in a local public variable to be accessible to the html template.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Then we find all the messages of the chat-room using query: <code>{where: JSON.stringify({room: this.room._id})}</code></td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>After getting all the messages of the chat-room, we set them in a local public array to be accessible to the html template.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>In the <code>ngOnDestroy</code> method we need to unsubscribe all the subscriptions, remove listeners for <code>socket.io</code> events, and emit <code>leave-chat-room</code> event so the server can know when a user has left the room. This method is always call whenever the user goes back using the back button.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>We emit the <code>add-message</code> event with the message text and the room id.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And also <code>chat-room.html</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-html hljs" data-lang="html">&lt;ion-header&gt;
  &lt;ion-toolbar&gt;
    &lt;ion-back-button slot="start" defaultHref="/select-room"&gt;&lt;/ion-back-button&gt; <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;ion-title&gt;
      Room: {{room.name}} <i class="conum" data-value="2"></i><b>(2)</b>
    &lt;/ion-title&gt;
  &lt;/ion-toolbar&gt;
&lt;/ion-header&gt;

&lt;ion-content&gt;
  &lt;ion-grid&gt;
    &lt;ion-row *ngFor="let message of messages"&gt;

      &lt;ion-col size="9" *ngIf="message.owner.nickname !== nickname" class="message"
               [ngClass]="{
                 'my_message': message.owner.nickname === nickname,
                 'other_message': message.owner.nickname !== nickname
                }"&gt; <i class="conum" data-value="3"></i><b>(3)</b>
        &lt;span class="user_name"&gt;{{ message.owner.nickname }}:&lt;/span&gt;&lt;br&gt;
        &lt;span&gt;{{ message.text }}&lt;/span&gt;
        &lt;div class="time"&gt;{{message.created | date:'dd.MM hh:MM'}}&lt;/div&gt;
      &lt;/ion-col&gt;

      &lt;ion-col offset="3" size="9" *ngIf="message.owner.nickname === nickname" class="message"
               [ngClass]="{
                 'my_message': message.owner.nickname === nickname,
                 'other_message': message.owner.nickname !== nickname
               }"&gt;
        &lt;span class="user_name"&gt;{{ message.owner.nickname }}:&lt;/span&gt;&lt;br&gt;
        &lt;span&gt;{{ message.text }}&lt;/span&gt;
        &lt;div class="time"&gt;{{message.created | date:'dd.MM hh:mm'}}&lt;/div&gt;
      &lt;/ion-col&gt;

    &lt;/ion-row&gt;
  &lt;/ion-grid&gt;

&lt;/ion-content&gt;

&lt;ion-footer&gt;
  &lt;ion-item&gt;
    &lt;ion-input type="text" placeholder="Message..." [(ngModel)]="message"&gt;&lt;/ion-input&gt;
    &lt;ion-button fill="clear" color="primary" slot="end" (click)="sendMessage()" [disabled]="!message" size="large"&gt;
      &lt;ion-icon name="send"&gt;&lt;/ion-icon&gt;
    &lt;/ion-button&gt;
  &lt;/ion-item&gt;
&lt;/ion-footer&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>we have to go back to <code>select-room</code> page instead <code>home</code> page</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instead of just showing <code>Chat</code> in the header, we now show <code>Room: &lt;room-name&gt;</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>now we compare <code>message.owner.nickname</code> instead comparing <code>message.from</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now launch your app and make sure your backend is up and running!</p>
</div>
<div class="paragraph">
<p>For testing, you can open a browser and another incognito browser like in my example at the top to chat with yourself.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you can see adding MongoDB to our project was relatively simple. Furthermore, <code>@nestjs/mongoose</code> give us the huge ability to connect and handle the database without writing too much code.</p>
</div>
<div class="paragraph">
<p>Now this application looks more real since we can store all the messages, rooms, and users in our database. This leads to the fact that now we can create different chat-rooms with separate conversations.</p>
</div>
<div class="paragraph">
<p>To finish I just want to point that we need to add some sort of authentication and authorization system. So that, only users with required permissions can access rooms and messages. We will do that in next tutorials.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments">Comments</h2>
<div class="sectionbody">
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
  this.page.url = 'https://nest-ionic-examples.github.io/02-chat-with-db/';
  this.page.identifier = '02-chat-with-db';
};

(function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://02-chat-with-db.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>
</div>
<script src="./highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>